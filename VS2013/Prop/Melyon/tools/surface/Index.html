<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script type="text/javascript" src="/contents/scripts/base.js"></script>
    <script type="text/javascript" src="/contents/scripts/loader.js"></script>
    <link href="/contents/css/screen.css" rel="stylesheet" />
    <link href="/contents/css/root.css" rel="stylesheet" />
</head>
<body>
    <div class="ab w-full h-full t-i-00 b-i-00 z05">
        <canvas id="renderCanvas" class=" cwhite w-full h-full"></canvas>
    </div>
    <div id="shaders" class="hdn"></div>
    <script src="/contents/scripts/engine/babylon.js"></script>
    <script src="/contents/scripts/engine/three.js"></script>
    <script src="/contents/scripts/3dbase.js"></script>
    <script src="/contents/scripts/3dbase_Initialize_BabylonJs.js"></script>
    <script src="/contents/scripts/3dMaterial.js"></script>
    <script src="/contents/scripts/3dTools.js"></script>
    <script type="text/javascript">
        var eng1, eng2, b = [], b2, ix = 0, iy = 0, iz = 0;
        eng1 = new $3d({ engine: createBabylonJsEngine(), geometry: createBabylonJsGeometry(), material: createBabylonJsMaterial() });
        eng1.engine.instance.canvas = document.getElementById('renderCanvas');
        var bx, bx1, phi = 0, theta = 0;
        var time = 0;
        eng1.engine.onRequestFrame = function () {

            time += 0.06;
            _for(b, function (it, i) {
                it.material.setVector3("camera", eng1.get().cameras.main.position);
                it.material.setFloat("time", time);

            });

        };

        function mat_sample(cl) {
            cl = def(cl, 0x000000);
            return sh_range({
                start: 10, end: 1000,
                mat1: sh_multi([
                    { r: sh_specular({ glass: true }), e: 0.20 },
                    { r: sh_specular({ glass: true, pos: 'vec3(10.,0.,0.)' }), e: 0.05 },
                    { r: sh_specular({ glass: true, pos: 'vec3(10.,100.,0.)' }), e: 0.035 },
                    { r: sh_phonge({ color: cl, back: 0x000000 }), e: 1.0 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,0.,0.)' }), e: 0.05 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,100.,0.)' }), e: 0.015 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,0.,100.)' }), e: 0.025 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,20.,0.)' }), e: 0.015 },
                    { r: 'float pi2 =((pos.x )- floor((pos.x )/10.)*10.)*8.  ; if(pi2 > 1.0) pi2 = 0.0; else pi2 = -0.1; result = vec4(pi2,pi2,pi2,1.0);', e: 1.0 },
                    { r: 'float pi3 =((pos.z )- floor((pos.z )/10.)*10.)*8.  ; if(pi3 > 1.0) pi3 = 0.0; else pi3 = -0.1; result = vec4(pi3,pi3,pi3,1.0);', e: 1.0 },
                    // { r: 'float pi4 =((pos.y )- floor((pos.y )/10.)*10.)*8.  ; if(pi4 > 1.0) pi4 = 0.0; else pi4 = -0.1; result = vec4(pi4,pi4,pi4,1.0);', e: 1.0 },
                    //  { r: 'float pp;pp = abs( noise(vec3(pos.x/2.,pos.y/2.,pos.z/2.)));if(pp < 0.05 || pp > 0.1) pp  = -1.*pp/3.0 ;else pp = -0.2;result = vec4(pp,pp,pp,1.0);', e: 0.12 },
                    { r: sh_frensel(), e: 0.3 }]),
                mat2: sh_multi([
                    { r: sh_specular({ glass: true }), e: 0.020 },
                    { r: sh_specular({ glass: true, pos: 'vec3(10.,0.,0.)' }), e: 0.05 },
                    { r: sh_specular({ glass: true, pos: 'vec3(10.,100.,0.)' }), e: 0.035 },
                    { r: 'result = vec4(1.,1.,1.,1.0);', e: 1.0 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,0.,0.)' }), e: 0.05 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,100.,0.)' }), e: 0.15 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,0.,100.)' }), e: 0.025 },
                    { r: sh_specular({ refc: 'refc2', pos: 'vec3(10.,20.,0.)' }), e: 0.015 },
                  //  { r: 'float pi2 =((pos.x )- floor((pos.x)/10.)*10.)*15.  ; if(pi2 > 1.0) pi2 = 0.0; else pi2 = -0.1; result = vec4(pi2,pi2,pi2,0.30);', e: 0.2 },
                  //  { r: 'float pi3 =((pos.z)- floor((pos.z)/10.)*10.)*15.  ; if(pi3 > 1.0) pi3 = 0.0; else pi3 = -0.1; result = vec4(pi3,pi3,pi3,0.30);', e: 0.2 },
                  //  { r: 'float pi4 =((pos.y)- floor((pos.y)/10.)*10.)*15.  ; if(pi4 > 1.0) pi4 = 0.0; else pi4 = -0.1; result = vec4(pi4,pi4,pi4,0.30);', e: 0.2 },
                    { r: sh_frensel(), e: 0.3 }])
            });
        }

        function mat() {

            var p = new $3d.iMaterial($3d.mat.frg(mat_sample(0xededed)), eng1).build();
            //p.material.wireframe = true;

            ref = new BABYLON.CubeTexture("/images/skybox/d2/skybox", eng1.get().scene);
            ref.coordinatesMode = BABYLON.Texture.CUBIC_MODE;
            var ref2 = new BABYLON.CubeTexture("/images/skybox/d/skybox", eng1.get().scene);
            ref2.coordinatesMode = BABYLON.Texture.CUBIC_MODE;


            p.setTexture("refc", ref);
            p.setTexture("refc2", ref2);
            p.setMatrix("refmat", ref.getReflectionTextureMatrix());

            return p;
        }
        eng1.engine.onInitScene = function () {

            var w = new $3d.tools.surface({
                paths: [[{ x: -10000, y: -10, z: -10000 }, { x: 10000, y: -10, z: -10000 }], [{ x: -10000, y: -10, z: 10000 }, { x: 10000, y: -10, z: 10000 }]],
                //flip:true
            }).toMesh(eng1);
            //w2.material = mat();

            //var w = new BABYLON.Mesh.CreateBox('s', 30, eng1.get().scene);
            w.material = mat();

            b.push(w);
        }
        eng1.start();


    </script>
    <div class="ab b-p50 t-p50 l-p50 r-p50 h-mn-10 w-mn-10 cblue z08 hdn">
        <textarea id="sct" class="owf-x w-full h-full" cols="50" rows="20"></textarea>
    </div>
    <div class="ab b-p50 t-p50 l-p50 r-p50 h-mn-10 w-mn-10 cblue z08 hdn">
        <textarea id="ssct" class="owf-x w-full h-full" cols="50" rows="20"></textarea>
    </div>
    <div id="point-template">
        <div class="pointitem">
            <input id="ch" type="checkbox" value="false" title="exactly points" />
            <input id="p" type="text" value="" placeholder="path or points" />
            <input id="d" type="text" value="" placeholder="dencity" onclick="try { curr = 0; setTo(getj(window.eval(this.value))); curr = 1; } catch (e) { }" />
            <input id="op" type="text" value="{}" placeholder="{transform}" />
            <input id="pl" type="text" class="w-02" value="800" placeholder="points count" />
            <input id="h" type="text" class="w-02" value="0.0" placeholder="vertical position" />
            <input type="button" class="w-01 h-01 c-t-ired " value="X" onclick="this.parentNode.outerHTML = '';" />
        </div>
    </div>

    <div id="surface-template">
        <div class="w-p60 cntr">
        </div>
        <div class="w-p25">
            <input type="button" class="w-01 h-01 c-t-iorg" value=" + " onclick="  get('.cntr', get('cntr')).appendChild(create(get('point-template').innerHTML));" />
            <input type="text" id="mat" onchange="test()" value="'result = vec4(1.0,0.,0.,1.0);'" list="material">
            <datalist id=material>
                <option value="mat_sample()"></option>
                <option value="sh_phonge()"></option>
                <option value="glasses()"></option>
                <option value="'result = vec4(1.0,0.,0.,1.0);'"></option>
            </datalist>
            <input id="wire" type="checkbox" onchange="test()" value="false" title="wireframe" placeholder="wire" />
            <input id="flip" type="checkbox" onchange="test()" value="false" title="flip" placeholder="flip" />
        </div>
        <div>
            <input type="button" class="w-auto h-01" value="apply" onclick="test()" />
            <input id="pts" type="button" class="w-auto h-01 c-t-iorg" value="src" onclick="get('sct').parentNode.classList.toggle('hdn');" />
            <input id="spts" type="button" class="w-auto h-01 c-t-iorg" value="src" onclick="get('ssct').parentNode.classList.toggle('hdn');" />
        </div>
    </div>
    <div id="main-template">
        <input type="button" value="surface" />
    </div>

    <div id="cntr" class="ab b-00 h-auto h-mx-05 owf-x h-mn-02 cblack t-auto w-full z06 f f-r pt-0025 pl-0025 pr-0025 pb-0025">
        <input type="button" value="+ Surface" onclick="new_surface()" />
        <input type="button" value="+ Wall" />
    </div>
    <div id="density" class="ab t-01 r-01 w-i-05 h-auto z06 hdn">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="range" class="w-full" min="0" max="100" onchange="test()">
        <input type="button" class="w-01 h-01" value="min" onclick="minall()" />
        <input type="button" class="w-01 h-01" value="ref" onclick="refall()" />
    </div>
    <script>
        var curr = 0;
        function minall() {
            all('#density > input', function (it, i) {
                it.value = 0.0;
            }, function () {

                test();
            });
        }
        function refall() {
            all('#density > input', function (it, i) {
                it.value = 50.0;
            }, function () {

                test();
            });
        }
        function setTo(ar) {

            minall();
            var th = first('#density > input');
            _for(ar, function (it, i) {

                try {
                    th.value = it * 50.;

                    th = th.nextElementSibling;
                }
                catch (e) { }
            });

        }
        function test() {
            if (def(b[1]))
                b[1].dispose();

            function AddNew() {
                var script = "{paths:@paths }";
                var script_ = "{paths:@paths }";
                var pts_s = [];
                var pts_s1 = [];

                  all('#cntr .cntr > .pointitem',
                    function (at, i) {
                        var h = getv('#h', at);
                        var push = function (r, n) { r.push({ x: -n.x + 100, y: h, z: n.y - 100 }); };

                        var pts = getv('#ch', at) ? getj('#p', at) : $3d.tools.svg.getPoints({ path: getv('#p', at), density: getj('#d', at), pointLength: getv('#pl', at) * 1.0, push: push });
                        var pts_1 = getv('#ch', at) ? getv('#p', at) : "$3d.tools.svg.getPoints({ path: \"" + getv('#p', at) + "\", density: " + getv('#d', at) + ", pointLength: " + getv('#pl', at) * 1.0 + ", push: function (r, n) { r.push({ x: -n.x + 100, y: " + h + ", z: n.y - 100 }); }  })";

                        pts_s.push(pts);
                        pts_s1.push(pts_1);
                    });


                script = script.replace("@paths", (pts_s).toString());

                script_ = script_.replace("@paths", (pts_s1).toString());

                get('sct').textContent = script;
                setv('#pts', floor(script.length / 10) / 100 + " kb" ,get('cntr'));
                get('ssct').textContent = script_;
                setv('#spts', floor(script_.length / 10) / 100 + " kb",get('cntr'));

                var w = new $3d.tools.surface({
                    paths: pts_s,
                    flip: getv('flip')
                }).toMesh(eng1);

                w.material = new $3d.iMaterial($3d.mat.frg(getj('#mat', get('cntr'))), eng1).build();
                w.material.wireframe = getv('#wire',  get('cntr'));

                ref = new BABYLON.CubeTexture("/images/skybox/d2/skybox", eng1.get().scene);
                ref.coordinatesMode = BABYLON.Texture.CUBIC_MODE;
                var ref2 = new BABYLON.CubeTexture("/images/skybox/d/skybox", eng1.get().scene);
                ref2.coordinatesMode = BABYLON.Texture.CUBIC_MODE;

                w.material.setTexture("refc", ref);
                w.material.setTexture("refc2", ref2);
                w.material.setMatrix("refmat", ref.getReflectionTextureMatrix());

                b[1] = w;
            }

            var s = '[';

            all('#density > input[type=range]', function (it, i) {
                if (it.value != 0)
                    s += "," + (it.value * 2.0) / 100.;
            }, function () {
                s = s.replace("[,", "[") + "]";
                if (s == "[]") s = "[1,1,1]";

                var ctl = all('#cntr .cntr > .pointitem')[curr];

                setv('#d', s, ctl); 
                AddNew();
            });
        }


        function new_surface() {
            get('cntr').innerHTML = get('surface-template').innerHTML;
            get('.cntr', get('cntr')).innerHTML = get('point-template').innerHTML + get('point-template').innerHTML;
        }

    </script>
</body>
</html>